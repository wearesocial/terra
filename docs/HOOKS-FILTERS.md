# Hooks & Filters

## Terra initialised on ajax request

When Terra is initialised after the ajax request the following actions are triggered:

```php
do_action( 'terra_init' );

// FORM NAME is the name passed to create_feed() or start() methods.
do_action( 'terra__[FORM NAME]' );
```

**NOTE:** `[FORM NAME]` is the form name specified when calling the [create_feed() or start()]() methods.

### Temp file

To avoid exposing the query parameters inside the HTML generated, Terra stores the data needed to properly run the WP_Query when performing ajax calls inside a temporary file.

This solution should work without problem in any environment and hosting, but in case something goes wrong this filter will be executed:

```php
do_action( 'terra_temp_failed' );
```

An error message is also printed in the debug log.

## Using a custom single item template

By default Terra is looking for the template (unless otherwise directed in `create_feed` or `start` methods):

`template-parts/[POST-TYPE]-single-item.php`

and, if no items are found:

`template-parts/[POST-TYPE]-single-item-none.php`

These values can be respectively customised with the following filters:

```php
$template = apply_filters( 'terra_template__[FORM NAME]', 'template-parts/' . $post_type . '-single-item.php', $post_type, $args );
```

and

```php
$template = apply_filters( 'terra_template__[FORM NAME]_none', 'template-parts/' . $post_type . '-single-item-none.php', $post_type, $args );
```

**NOTE:** `[FORM NAME]` is the form name specified when calling the [create_feed() or start()]() methods.

### Example

```php
/**
 * The template to use is "template-parts/new-file-to-use.php"
 */
add_filter( 'terra_template__custom', function( $template_name, $post_type, $args ) {
	return 'template-parts/new-file-to-use';
}, 10, 3 );
```
```php
/**
 * We can also use some logic to not display a post
 */
add_filter( 'terra_template__custom', function( $template_name, $post_type, $args ) {
  if ( get_the_ID() === 1 ) {
    return null;  // We don't want the post with ID 1 to be ever displayed!
  }

  return $template_name;
}, 10, 3 );
```

## WP_Query parameters

Terra by default tries to handle all the filters present in the URL. So, if the filter starts with the key `filter-` Terra checks if the remaining part of the name matches the name of any registered taxonomy, if so automatically applies the filter for you.
Also, if the filter starts with the key `meta-` instead, the `meta_query` will be automatically generated by Terra.

Terra also automatically recognises the following "special" keys:

| key    | description                                                        |
| ------ | ------------------------------------------------------------------ |
| sort   | This will set the option "order" for the WP_Query                  |
| sortby | This will set the option "orderby" prefixed by the string 'post\_' |

On top of that Terra offers these 2 filters: `terra_args` and `terra_args__[FORM NAME]` to allowing you customise the parameters passed by Terra to the WP_Query.

**NOTE:** `[FORM NAME]` is the form name specified when calling the `create_feed()` or `start()` functions.

### Usage

**`terra_args`**: this filter is always executed:

```php
// This filter allows you to customise all the requests
add_filter( 'terra_args', function( array $args, array $params, array $terra_params ) { ... }, 10, 3 );
```

- `$args` _(array)_ the arguments to be passed to the WP_Query
- `$params` _(array)_ the arguments got from the AJAX request
- `$terra_params` _(array)_ the internal parameters stored by Terra like: page_id, base_url, pagination, etc.

**`terra_args__[FORM_NAME]`** is triggered only when:

- passing `'terra' => [FORM_NAME]` parameter to the [custom WP_Query]()
- when the `?query=[FORM_NAME]` parameter is present on the page load
- when performing the AJAX request

```php
// This filter allows you to customise only the requests coming from a specific form name.
add_filter( 'terra_args__[FORM NAME]', function( array $args, array $params, array $terra_params ) { ... }, 10, 3 );
```

- `$args` _(array)_ the arguments to be passed to the WP_Query
- `$params` _(array)_ the arguments got from the AJAX request
- `$terra_params` _(array)_ the internal parameters stored by Terra like: page_id, base_url, pagination, etc.

_Note:_ when working with the main query Terra doesn't know if it has to run those filters, unless the parameter `?query=[...]` is present in the URL. But another way to make Terra trigger the filter is by manually passing `'terra' => [FORM_NAME]` to the main query:

```php
add_action( 'pre_get_posts', 'add_terra_parameter_to_main_query' );

/**
 * Adding 'terra' => 'test' will allow Terra to trigger the filter `terra_args__test`
 */
function add_terra_parameter_to_main_query( $query ) {
  if ( is_archive( 'test' ) ) {
    $query->set( 'terra', 'test' );
  }
}
```

This will allow us to use the same filter for the main query and the one generated by Terra.

### Example

```php
/**
 * This filter is called by Terra with the argument array to be passed to WP_Query.
 *
 * @param array $args   array of arguments to pass to WP_Query.
 * @param array $params all the form input fields.
 */
function test_args( $args, $params ) {
  $args['meta_key'] = 'META_KEY';
  $args['meta_value'] = 'META_VALUE';

  return $args;
} );

add_filter( 'terra_args__[FORM_NAME]', 'test_args', 10, 2 );
```

## Before the loop

The `terra_before_loop__[FORM NAME]` filter allows adding 3rd party HTML before the Terra's loop that outputs the single items.

### Usage

```php
do_action( 'terra_before_loop__[FORM NAME]', $posts, $args, $params );
```

### Example

```php
/**
 * This function is invoked before Terra's loop
 *
 * @param WP_Query $posts the WP_Query.
 * @param array    $args the arguments passed to WP_Query.
 * @param array    $params the form fields.
 */
function test_before_loop( $posts, $args, $params ) {

}

// testname is the name we passed to the function Terra::start
add_action( 'terra_before_loop__testname', 'test_before_loop', 10, 3 );
```

## Inside the loop

The `terra_inside_loop_before__[FORM NAME]` action allows adding 3rd party HTML inside Terra's loop that outputs the single items. The function will be executed before the post template is rendered. This is useful if you want to insert HTML into the middle of the loop at a specific place.

Likewise, `terra_inside_loop_after__[FORM NAME]` allows inserting HTML just after the template file is rendered.

### Usage

```php
add_action( 'terra_inside_loop_before__' . $name, $count, $post_id, $params );
add_action( 'terra_inside_loop_after__' . $name, $count, $post_id, $params );
```

### Example

```php
/**
 * This function is invoked inside Terra's loop
 *
 * @param int   $count post count number.
 * @param int   $post_id the current post ID.
 * @param array $params the form fields.
 */
function test_inside_loop( $count, $post_id, $params ) {
  // Insert before 3rd post.
	if ( $count === 2 ) {
		get_template_part( 'template-parts', 'some-part' );
	}
}

// testname is the name we passed to the function Terra::start
add_action( 'terra_inside_loop__testname', 'test_inside_loop', 10, 3 );
```

## After the loop

The `terra_after_loop__[FORM NAME]` filter allows adding 3rd party HTML after the Terra's loop that output the single items.

### Usage

```php
do_action( 'terra_after_loop__[FORM NAME]', $posts, $args, $params );
```

### Example

```php
/**
 * This function is invoked after Terra's loop
 *
 * @param WP_Query $posts the WP_Query.
 * @param array    $args the arguments passed to WP_Query.
 * @param array    $params the form fields.
 */
function test_after_loop( $posts, $args ) {

}

add_action( 'terra_after_loop__testname', 'test_after_loop', 10, 3 );
```

## Hidden fields

Hidden &lt;input&gt; fields are used by Terra to store all parameters passed to the WP_Query and they are used when loading the new results via Ajax.
The class stores informations such as: `post_type`, `order`, `meta` or `tax` query, etc.

It's possible alter the information stored in those fields with the following filter:

```php
/**
 * @param string $field_value the "value" attribute to pass to the hidden input
 * @param string $field_name the hidden input "name" value attribute.
 */
apply_filters( 'terra_hidden_field', $field_value, $field_name );

// To target a specific form:
apply_filters( 'terra_hidden_field__[FORM_NAME]', $field_value, $field_name );
```

**NOTE**: To not generate a hidden input for a specific field name, return an empty value using one of the above filters.

## Pagination

Terra has built-in functionality for the pagination, if specifing `true` when [closing the container]().

The default template uses the [WP paginate_links](https://codex.wordpress.org/Function_Reference/paginate_links) function, and Terra allows you to customise the arguments sent to this function with the following filters:

```php
$args = apply_filters( 'terra_pagination_args', $args, $show_ends, $params );

// To target a specific form
$args = apply_filters( 'terra_pagination_args__[FORM_NAME]', $args, $show_ends, $params );
```

The default template used for the pagination is saved in `templates/pagination.php`, but Terra allows you to use your own by using one of following filters:

```php
/**
 * @param string   $terra_template the default terra pagination template
 * @param WP_Query $query         the query that needs the pagination
 */
$terra_template = apply_filters( 'terra_pagination_template', $terra_template, $query );

// To target a specific form
$terra_template = apply_filters( 'terra_pagination_template__[FORM_NAME]', $terra_template, $query );
```

## JavaScript

The `terraStart` and `terraDone` events are triggered respectively before the AJAX call has started and after it has been completed and all the items retrieved.

### Example

```js
/**
 * terraStart is triggered before doing the ajax call
 *
 * @param Javascript Event event the JS event.
 * @param "jQuery Element" $form the Terra form used to load the more/new data.
 * @param "jQuery Element" $container the container where the data has been added.
 */
$('body').on('terraStart', (event, $form, $container) => {
  console.info({ $form });
});

/**
 * terraDone is triggered after the data has been added to the DOM.
 *
 * @param Javascript Event event the JS event.
 * @param "jQuery Element" $container the container where the data has been added.
 * @param "jQuery Element" $items the elements that have been added.
 */
$('body').on('terraDone', (event, $container, $items) => {
  console.info({ $items });
});
```

## Trigger Terra programmatically

To trigger Terra, trigger its submit form.

```js
jQuery('form.terra').trigger('submit');
```

## Feed Block Template

This filter allows the developer to replace the template used to render the [Terra Feed Block](). Default templates is located in `templates/feed-block.php`.

### Usage

```php
$feed_template = apply_filters( 'terra_feed_block_template', __DIR__ . '/templates/feed-block.php' );
```

### Example

```php
/**
 * This function replaces the feed block template
 *
 * @param string $template the feed block template.
 */
function test_after_loop( $template ) {
  $template = 'template-parts/feed-block.php';
  return $template;
}

add_action( 'terra_feed_block_template', 'feed_block_template', 10, 1 );
```
